# F3.1.2 - Webhook System

## Overview
Webhook system for real-time event notifications with HMAC-SHA256 request signing, exponential backoff retries, delivery logging, and pre-built templates for common integrations.

## Architecture

### Webhook Registration
- Organizations register webhook endpoints via the management API or dashboard UI
- Each webhook specifies a target URL, subscribed events, and optional custom headers
- A unique signing secret is generated per webhook and stored as a SHA-256 hash
- Webhooks can be scoped to specific event types (e.g., `spec.created`, `epic.updated`)
- Status can be `active`, `paused`, or `disabled`; only `active` webhooks receive deliveries

### Event System
- Events are emitted from Strapi lifecycle hooks and Next.js API route handlers
- Supported event categories: `spec`, `epic`, `feature`, `comment`, `member`, `export`
- Each event includes: event type, timestamp, organization ID, actor, and resource payload
- Events are dispatched asynchronously to avoid blocking the originating request
- Payload field filtering allows webhooks to receive only selected fields per event

### HMAC Signing
- Every outgoing webhook request is signed with HMAC-SHA256
- Signature is computed over the raw JSON payload using the webhook's secret
- Signature is sent in the `X-Webhook-Signature-256` header as `sha256=<hex>`
- A timestamp is included in `X-Webhook-Timestamp` to prevent replay attacks
- Consumers should verify the signature and reject requests older than 5 minutes

### Retry Logic
- Failed deliveries (non-2xx status or network error) trigger automatic retries
- Exponential backoff schedule: 30s, 2min, 10min, 30min, 2hr (5 attempts total)
- Each attempt is recorded as a separate delivery log entry
- After all retries are exhausted, the webhook `failureCount` is incremented
- Webhooks with 10+ consecutive failures are automatically set to `disabled`

### Health Monitoring
- `failureCount` tracks consecutive delivery failures per webhook
- `lastDeliveryAt` and `lastDeliveryStatus` provide at-a-glance health info
- The dashboard displays delivery success rate, average latency, and recent failures
- Organization admins receive in-app notifications when a webhook is auto-disabled

### Templates
- Pre-built webhook templates for common integrations: Slack, Discord, Jira, Linear, Zapier
- Templates define default event subscriptions, payload transformations, and custom headers
- Users can start from a template and customize the configuration
- Template payloads are formatted for the target platform (e.g., Slack Block Kit)

## Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/webhooks | List webhooks for the organization |
| POST | /api/v1/webhooks | Register a new webhook |
| GET | /api/v1/webhooks/:id | Get webhook details |
| PATCH | /api/v1/webhooks/:id | Update webhook configuration |
| DELETE | /api/v1/webhooks/:id | Delete a webhook |
| POST | /api/v1/webhooks/:id/test | Send a test event to the webhook |
| GET | /api/v1/webhooks/:id/deliveries | List delivery logs for a webhook |

## Response Formats

### Success (single)
```json
{
  "data": {
    "id": "wh_abc123",
    "name": "Production Slack Notifications",
    "url": "https://hooks.slack.com/services/T00/B00/xxx",
    "events": ["spec.created", "spec.updated", "epic.created"],
    "status": "active",
    "failureCount": 0,
    "lastDeliveryAt": "2026-02-15T10:30:00Z",
    "lastDeliveryStatus": 200,
    "createdAt": "2026-01-10T08:00:00Z"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Success (list)
```json
{
  "data": [
    {
      "id": "wh_abc123",
      "name": "Production Slack Notifications",
      "url": "https://hooks.slack.com/services/T00/B00/xxx",
      "events": ["spec.created", "spec.updated"],
      "status": "active",
      "failureCount": 0,
      "lastDeliveryAt": "2026-02-15T10:30:00Z",
      "lastDeliveryStatus": 200
    }
  ],
  "meta": {
    "apiVersion": "v1",
    "requestId": "req_...",
    "pagination": { "page": 1, "pageSize": 25, "pageCount": 1, "total": 3 }
  }
}
```

### Delivery Log Entry
```json
{
  "data": {
    "id": "del_xyz789",
    "webhookId": "wh_abc123",
    "event": "spec.created",
    "payload": { "id": 42, "title": "New Specification", "createdAt": "2026-02-15T10:30:00Z" },
    "statusCode": 200,
    "latencyMs": 245,
    "attemptNumber": 1,
    "maxAttempts": 5,
    "success": true,
    "createdAt": "2026-02-15T10:30:00Z"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Test Event Response
```json
{
  "data": {
    "success": true,
    "statusCode": 200,
    "latencyMs": 312,
    "message": "Test event delivered successfully"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Error
```json
{
  "error": {
    "code": "WEBHOOK_NOT_FOUND",
    "message": "Webhook not found",
    "status": 404
  }
}
```

## Files

### Utilities
- `Client/lib/api/webhook-client.ts` - Webhook HTTP client with HMAC signing
- `Client/lib/api/webhook-events.ts` - Event type definitions and dispatcher
- `Client/lib/api/webhook-retry.ts` - Exponential backoff retry logic
- `Client/lib/api/webhook-templates.ts` - Pre-built integration templates (Slack, Discord, Jira, Linear, Zapier)
- `Client/lib/api/webhook-validator.ts` - Webhook URL and payload validation

### API Routes
- `Client/app/api/v1/webhooks/route.ts` - Webhooks list/create
- `Client/app/api/v1/webhooks/[webhookId]/route.ts` - Webhook get/update/delete
- `Client/app/api/v1/webhooks/[webhookId]/test/route.ts` - Send test event
- `Client/app/api/v1/webhooks/[webhookId]/deliveries/route.ts` - Delivery log list

### Redux
- `Client/lib/store/webhook-slice.ts` - Webhook management state and actions

### UI Components
- `Client/components/dashboard/webhooks/WebhookList.tsx` - Webhook list with status indicators
- `Client/components/dashboard/webhooks/WebhookForm.tsx` - Create/edit webhook form
- `Client/components/dashboard/webhooks/WebhookDetails.tsx` - Webhook detail view with delivery history
- `Client/components/dashboard/webhooks/WebhookTemplates.tsx` - Template selection for quick setup
- `Client/components/dashboard/webhooks/DeliveryLog.tsx` - Delivery log table with filtering
- `Client/components/dashboard/webhooks/WebhookManagementPanel.tsx` - Combined management panel

### Strapi
- `Server/src/api/webhook/` - Webhook content type
- `Server/src/api/webhook-delivery/` - Webhook delivery log content type
