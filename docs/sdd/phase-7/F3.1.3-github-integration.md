# F3.1.3 - GitHub Integration

## Overview
GitHub integration providing OAuth-based repository access, bidirectional document sync, issue linking for specification traceability, pull request generation from spec changes, and GitHub Actions workflow templates for CI/CD pipelines.

## Architecture

### OAuth Flow
- Users initiate GitHub OAuth from the integrations settings page
- The server redirects to GitHub's authorization endpoint with requested scopes (`repo`, `read:org`)
- On callback, the authorization code is exchanged for an access token
- The access token is encrypted (AES-256-GCM) before storage in the `github-connection` content type
- Token refresh is handled transparently; expired tokens trigger a re-authorization prompt
- Each connection is scoped to a single GitHub user and linked to one organization

### Repository Sync
- Organizations configure sync settings per repository via the `github-sync-config` content type
- Each config specifies the repository, target branch, sync path (e.g., `/docs`), and auto-sync preference
- On manual or automatic trigger, spec documents are serialized to Markdown and committed to the configured path
- Incoming changes from GitHub (detected via webhook or polling) are parsed and merged into the spec tree
- The `syncStatus` field tracks the current state: `synced`, `pending`, `conflict`, or `error`
- `pendingChanges` counts the number of local changes awaiting push to GitHub

### Issue Linking
- Spec nodes (epics, features, user stories) can be linked to GitHub issues via the `github-issue-link` content type
- Links are created manually from the spec tree UI or automatically when issues are created from specs
- Each link records the spec node type, spec node ID, issue number, issue title, and current state
- Issue state (`open`/`closed`) is periodically synced from GitHub to keep the dashboard current
- Linked issues appear as badges on spec tree nodes, providing at-a-glance implementation status

### PR Generation
- Users can generate pull requests directly from spec changes in the dashboard
- The system creates a feature branch, commits the updated spec documents, and opens a PR
- PR descriptions are auto-populated with a summary of changed specs, including links back to the app
- Draft PRs are supported for work-in-progress changes
- PR status is tracked and displayed alongside the sync configuration

### Actions Templates
- Pre-built GitHub Actions workflow templates are available for common CI/CD patterns
- Templates include: spec validation on PR, auto-sync on merge, spec-to-docs publishing, and issue triage
- Users can browse templates, preview the YAML, and install them directly to their repository
- Installed templates are committed to `.github/workflows/` via the GitHub API
- Template variables (org name, sync path, branch) are interpolated before installation

### Conflict Detection
- Bidirectional sync requires conflict detection when both sides have changed the same document
- Conflicts are detected by comparing content hashes of the local spec and the remote file
- When a conflict is found, the `syncStatus` is set to `conflict` and the user is notified
- The conflict resolution UI shows a side-by-side diff with options to accept local, accept remote, or merge manually
- Resolved conflicts are committed with a merge message referencing both versions

## Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/github/connections | List GitHub connections for the organization |
| POST | /api/v1/github/connections | Create a new GitHub connection (OAuth callback) |
| DELETE | /api/v1/github/connections/:id | Revoke and delete a GitHub connection |
| GET | /api/v1/github/repos | List accessible repositories for the authenticated connection |
| GET | /api/v1/github/sync-configs | List sync configurations for the organization |
| POST | /api/v1/github/sync-configs | Create a new sync configuration |
| GET | /api/v1/github/sync-configs/:id | Get sync configuration details |
| PATCH | /api/v1/github/sync-configs/:id | Update sync configuration |
| DELETE | /api/v1/github/sync-configs/:id | Delete a sync configuration |
| POST | /api/v1/github/sync-configs/:id/sync | Trigger a manual sync |
| GET | /api/v1/github/sync-configs/:id/conflicts | List unresolved conflicts for a sync config |
| POST | /api/v1/github/sync-configs/:id/conflicts/:conflictId/resolve | Resolve a sync conflict |
| GET | /api/v1/github/issue-links | List issue links for a spec node or organization |
| POST | /api/v1/github/issue-links | Create a new issue link |
| DELETE | /api/v1/github/issue-links/:id | Remove an issue link |
| POST | /api/v1/github/issue-links/create-issue | Create a GitHub issue from a spec node and link it |
| POST | /api/v1/github/pull-requests | Generate a PR from spec changes |
| GET | /api/v1/github/pull-requests/:id/status | Check PR status |
| GET | /api/v1/github/actions/templates | List available GitHub Actions templates |
| POST | /api/v1/github/actions/templates/:templateId/install | Install a template to a repository |

## Response Formats

### Success (single connection)
```json
{
  "data": {
    "id": "ghc_abc123",
    "githubUsername": "octocat",
    "scopes": ["repo", "read:org"],
    "tokenExpiresAt": "2026-03-15T00:00:00Z",
    "createdAt": "2026-02-10T08:00:00Z"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Success (repository list)
```json
{
  "data": [
    {
      "id": 123456,
      "fullName": "octocat/my-project",
      "private": true,
      "defaultBranch": "main",
      "description": "A sample project repository",
      "updatedAt": "2026-02-14T12:00:00Z"
    }
  ],
  "meta": {
    "apiVersion": "v1",
    "requestId": "req_...",
    "pagination": { "page": 1, "pageSize": 30, "pageCount": 1, "total": 5 }
  }
}
```

### Success (sync config)
```json
{
  "data": {
    "id": "gsc_def456",
    "repoId": 123456,
    "repoFullName": "octocat/my-project",
    "syncPath": "/docs",
    "branch": "main",
    "autoSync": true,
    "lastSyncAt": "2026-02-15T10:30:00Z",
    "syncStatus": "synced",
    "pendingChanges": 0,
    "createdAt": "2026-02-10T09:00:00Z"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Success (issue link)
```json
{
  "data": {
    "id": "gil_ghi789",
    "specNodeType": "feature",
    "specNodeId": "feat_42",
    "issueNumber": 87,
    "issueTitle": "Implement user authentication flow",
    "issueState": "open",
    "repoFullName": "octocat/my-project",
    "createdAt": "2026-02-12T14:00:00Z"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Success (PR generation)
```json
{
  "data": {
    "prNumber": 42,
    "prUrl": "https://github.com/octocat/my-project/pull/42",
    "branch": "spectree/sync-2026-02-15",
    "title": "Update spec documents (3 changes)",
    "status": "open",
    "draft": false,
    "createdAt": "2026-02-15T11:00:00Z"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Success (sync trigger)
```json
{
  "data": {
    "syncId": "sync_jkl012",
    "status": "in_progress",
    "direction": "push",
    "changesDetected": 3,
    "startedAt": "2026-02-15T10:30:00Z"
  },
  "meta": { "apiVersion": "v1", "requestId": "req_..." }
}
```

### Error
```json
{
  "error": {
    "code": "GITHUB_TOKEN_EXPIRED",
    "message": "GitHub access token has expired. Please re-authorize.",
    "status": 401
  }
}
```

## Files

### Utilities
- `Client/lib/api/github-client.ts` - GitHub API client with OAuth token management
- `Client/lib/api/github-sync.ts` - Bidirectional sync engine with conflict detection
- `Client/lib/api/github-issues.ts` - Issue linking and state synchronization
- `Client/lib/api/github-pr.ts` - Pull request generation and status tracking
- `Client/lib/api/github-actions-templates.ts` - GitHub Actions workflow template definitions
- `Client/lib/api/github-crypto.ts` - AES-256-GCM token encryption and decryption

### API Routes
- `Client/app/api/v1/github/connections/route.ts` - Connections list/create
- `Client/app/api/v1/github/connections/[connectionId]/route.ts` - Connection delete
- `Client/app/api/v1/github/repos/route.ts` - Repository listing
- `Client/app/api/v1/github/sync-configs/route.ts` - Sync configs list/create
- `Client/app/api/v1/github/sync-configs/[configId]/route.ts` - Sync config get/update/delete
- `Client/app/api/v1/github/sync-configs/[configId]/sync/route.ts` - Manual sync trigger
- `Client/app/api/v1/github/sync-configs/[configId]/conflicts/route.ts` - Conflict listing
- `Client/app/api/v1/github/sync-configs/[configId]/conflicts/[conflictId]/resolve/route.ts` - Conflict resolution
- `Client/app/api/v1/github/issue-links/route.ts` - Issue links list/create
- `Client/app/api/v1/github/issue-links/[linkId]/route.ts` - Issue link delete
- `Client/app/api/v1/github/issue-links/create-issue/route.ts` - Create issue from spec node
- `Client/app/api/v1/github/pull-requests/route.ts` - PR generation
- `Client/app/api/v1/github/pull-requests/[prId]/status/route.ts` - PR status check
- `Client/app/api/v1/github/actions/templates/route.ts` - Templates listing
- `Client/app/api/v1/github/actions/templates/[templateId]/install/route.ts` - Template installation

### Redux
- `Client/lib/store/github-slice.ts` - GitHub integration state, connections, sync configs, and issue links

### UI Components
- `Client/components/dashboard/github/GitHubConnectionPanel.tsx` - OAuth connection management
- `Client/components/dashboard/github/RepoSelector.tsx` - Repository selection with search and filtering
- `Client/components/dashboard/github/SyncConfigList.tsx` - Sync configuration list with status indicators
- `Client/components/dashboard/github/SyncConfigForm.tsx` - Create/edit sync configuration form
- `Client/components/dashboard/github/SyncStatusBadge.tsx` - Visual sync status indicator
- `Client/components/dashboard/github/ConflictResolver.tsx` - Side-by-side diff conflict resolution UI
- `Client/components/dashboard/github/IssueLinkList.tsx` - Issue links table with state badges
- `Client/components/dashboard/github/IssueLinkForm.tsx` - Link spec node to existing issue
- `Client/components/dashboard/github/CreateIssueDialog.tsx` - Create GitHub issue from spec node
- `Client/components/dashboard/github/PRGenerationDialog.tsx` - Pull request generation wizard
- `Client/components/dashboard/github/ActionsTemplateGallery.tsx` - Browse and install Actions templates
- `Client/components/dashboard/github/GitHubIntegrationPanel.tsx` - Combined integration management panel

### Strapi
- `Server/src/api/github-connection/` - GitHub connection content type
- `Server/src/api/github-sync-config/` - Sync configuration content type
- `Server/src/api/github-issue-link/` - Issue link content type
