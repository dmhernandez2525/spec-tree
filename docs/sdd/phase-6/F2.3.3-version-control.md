# Software Design Document: Version Control

## Metadata

| Field | Value |
|-------|-------|
| **Feature ID** | F2.3.3 |
| **Status** | In Progress |
| **Created** | 2026-02-15 |
| **Last Updated** | 2026-02-15 |
| **Author** | Daniel Hernandez |
| **Assignee** | Codex |
| **Branch** | `feat/F2.3.3-version-control` |
| **PR** | #95 (existing WIP branch context) |
| **Phase** | 6 |
| **Priority** | P1 |
| **Estimated Effort** | 3 days |

---

## 1. Overview

### 1.1 Brief Description
Add full version control capabilities for the spec tree, including named snapshots, timeline metadata, compare-any-two mode, side-by-side diff, safe restore, export of historical snapshots, auto-snapshot triggers, and branching from historical versions.

### 1.2 Business Value
- Protects teams from accidental data loss via rollback and restore safety.
- Improves collaboration confidence with visible change history and milestone tagging.
- Enables experimentation through snapshot branching.

---

## 2. User Story

**As a** product or engineering team member,  
**I want** to snapshot, compare, and safely restore versions of the specification tree,  
**So that** we can iterate quickly while preserving auditability and recovery paths.

---

## 3. Acceptance Criteria

- [x] AC-1: Create named snapshots with optional description.
- [x] AC-2: Mark snapshots as milestones with tags.
- [x] AC-3: Compare any two snapshots with side-by-side diff summary.
- [x] AC-4: Show added, removed, and modified nodes across work item levels.
- [x] AC-5: Restore requires confirmation and creates rollback safety snapshot.
- [x] AC-6: Export a historical snapshot as downloadable JSON.
- [x] AC-7: Auto-snapshot supports significant events (`batch-generation`, `bulk-move`, `import`).
- [x] AC-8: Timeline UI highlights milestone versions.
- [x] AC-9: Branching from a snapshot creates a linked parallel variant.
- [x] AC-10: Snapshot metadata is persisted in Strapi.

---

## 4. Technical Design

### 4.1 Data Model Additions

Version snapshot metadata additions:
- `tags: string[]`
- `isMilestone: boolean`
- `sourceEvent: 'manual' | 'batch-generation' | 'bulk-move' | 'import' | 'restore' | 'branch'`
- `branchName?: string`
- `parentSnapshot?: relation(version-snapshot)`

### 4.2 Client Architecture

- `version-snapshots.ts` builds immutable snapshot payloads.
- `version-diff.ts` computes structured diffs for compare mode.
- `version-control` UI provides timeline, compare, restore, export, and branch actions.
- Browser custom event `spectree:auto-snapshot` triggers automatic snapshot creation.

### 4.3 Restore Safety

Before restoring a selected snapshot:
1. Capture a safety snapshot of current state.
2. Apply selected snapshot to Redux store.
3. Close dialog and refresh list.

### 4.4 Event Triggers

Auto snapshot is triggered from:
- Batch generation actions.
- Bulk move actions.
- Import confirmation flow.

---

## 5. Files Affected

### New

- `docs/sdd/phase-6/F2.3.3-version-control.md`
- `docs/sdd/phase-6/PHASE_6_OVERVIEW.md`
- `Client/components/spec-tree/lib/utils/version-diff.ts`
- `Client/components/spec-tree/lib/utils/version-diff.test.ts`

### Modified

- `Client/components/spec-tree/components/version-control/index.tsx`
- `Client/components/spec-tree/components/builder/builder.tsx`
- `Client/components/spec-tree/components/import-export/index.tsx`
- `Client/components/spec-tree/lib/api/strapi-service.ts`
- `Client/types/version-snapshot.ts`
- `Client/types/strapi.ts`
- `Server/src/api/version-snapshot/content-types/version-snapshot/schema.json`
- `Server/src/api/version-snapshot/controllers/version-snapshot.ts`

---

## 6. Testing Strategy

- Unit tests for diff algorithm correctness (added/removed/modified).
- Component tests for compare mode, restore flow, and auto-snapshot behavior.
- Service tests for snapshot metadata request/response mapping.

---

## 7. Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Too many auto snapshots | Cooldown guard and event scoping |
| Invalid restore target | Confirmation dialog and fallback error handling |
| Snapshot payload drift | Typed snapshot builder and tests |

---

## 8. Definition of Done

- [x] Snapshot metadata persisted and retrievable.
- [x] Diff viewer supports two-snapshot comparisons.
- [x] Restore includes rollback safety.
- [x] Auto snapshot events wired in core flows.
- [x] Tests added for diff and UI behavior.

