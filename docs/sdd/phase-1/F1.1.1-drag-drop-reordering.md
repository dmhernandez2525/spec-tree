# SDD: F1.1.1 - Drag-and-Drop Reordering

## Document Control

| Field | Value |
|-------|-------|
| **Feature ID** | F1.1.1 |
| **Feature Name** | Drag-and-Drop Reordering |
| **Phase** | 1 - Foundation |
| **Priority** | P0 (Critical) |
| **Status** | ðŸ“‹ Planned |
| **Effort** | Medium (3-5 days) |
| **Author** | Setup Agent |
| **Created** | January 17, 2026 |
| **Last Updated** | January 17, 2026 |

---

## 1. Overview

### 1.1 Problem Statement

Users cannot reorder work items (Epics, Features, User Stories, Tasks) in the Spec Tree hierarchy. Items are displayed in creation order, which doesn't reflect the user's desired priority or logical grouping.

### 1.2 Solution Summary

Implement drag-and-drop functionality that allows users to:
1. Reorder items within the same hierarchical level
2. Move items between different parent containers (re-parenting)
3. See visual feedback during drag operations
4. Have changes persist to the database

### 1.3 Success Metrics

| Metric | Target |
|--------|--------|
| User can complete a reorder operation | < 500ms response time |
| Position changes persist correctly | 100% accuracy |
| No data loss during drag operations | 0 data loss incidents |
| Keyboard accessibility | WCAG 2.1 AA compliant |

---

## 2. Requirements

### 2.1 Functional Requirements

| ID | Requirement | Priority |
|----|-------------|----------|
| FR-1 | Users can drag work items to reorder within the same parent | P0 |
| FR-2 | Users can drag items to a different parent (re-parenting) | P0 |
| FR-3 | Visual drag indicator shows current item being dragged | P0 |
| FR-4 | Drop indicator shows valid drop locations | P0 |
| FR-5 | Position changes persist to Strapi CMS | P0 |
| FR-6 | Optimistic UI update with rollback on error | P1 |
| FR-7 | Keyboard shortcuts for reordering (Alt+Up/Down) | P1 |
| FR-8 | Undo/redo support for reorder operations | P2 |

### 2.2 Non-Functional Requirements

| ID | Requirement | Target |
|----|-------------|--------|
| NFR-1 | Drag operation must feel responsive | < 16ms frame time |
| NFR-2 | Position update API call | < 500ms |
| NFR-3 | Support lists with 100+ items | No performance degradation |
| NFR-4 | Work on touch devices | Functional on tablet |
| NFR-5 | Screen reader announces reorder | WCAG 2.1 AA |

---

## 3. Technical Design

### 3.1 Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Drag-Drop Architecture                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  React Component Tree                â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  DndContext (from @dnd-kit/core)              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Handles drag start/over/end events         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Manages collision detection                â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                       â”‚                              â”‚   â”‚
â”‚  â”‚                       â–¼                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  SortableContext                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Provides sortable items array              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Handles sorting strategy                   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                       â”‚                              â”‚   â”‚
â”‚  â”‚                       â–¼                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  TreeItem (Sortable)                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - useSortable() hook                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Drag handle                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - Visual feedback                            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â”‚ onDragEnd                       â”‚
â”‚                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  State Management                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  Zustand Store â”‚  â”‚  TanStack Query        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  (UI State)    â”‚  â”‚  (Server State)        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  - draggedItem â”‚  â”‚  - workItems query     â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  - dropTarget  â”‚  â”‚  - reorder mutation    â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â”‚ API Call                        â”‚
â”‚                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  Strapi CMS                          â”‚   â”‚
â”‚  â”‚  PUT /api/work-items/:id                             â”‚   â”‚
â”‚  â”‚  { position: number, parentId?: string }             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Library Choice

**Recommendation: @dnd-kit** over existing react-beautiful-dnd

| Factor | @dnd-kit | react-beautiful-dnd |
|--------|----------|---------------------|
| Maintenance | Active (2024) | Deprecated by Atlassian |
| Bundle size | 11kb | 30kb |
| TypeScript | Native | @types package |
| Tree structures | Excellent support | Limited |
| Accessibility | Built-in | Built-in |
| Touch support | Native | Requires polyfill |

**Note:** The project currently has `react-beautiful-dnd` and `react-dnd` installed. We recommend migrating to `@dnd-kit` for better tree support and active maintenance.

### 3.3 Data Model Changes

#### Strapi Work Item Schema Update

Add `position` field to work item content type:

```json
// Server/src/api/work-item/content-types/work-item/schema.json
{
  "attributes": {
    "position": {
      "type": "integer",
      "default": 0,
      "required": true
    }
    // ... existing attributes
  }
}
```

#### TypeScript Type Update

```typescript
// Client/types/work-item.ts
export interface WorkItem {
  id: string;
  documentId: string;
  title: string;
  description: string;
  type: 'app' | 'epic' | 'feature' | 'story' | 'task';
  status: 'draft' | 'active' | 'completed' | 'archived';
  position: number;  // NEW FIELD
  parentId: string | null;
  children?: WorkItem[];
  // ... other fields
}

export interface ReorderPayload {
  itemId: string;
  newPosition: number;
  newParentId?: string | null;
}
```

### 3.4 Component Structure

```
Client/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ tree-view/
â”‚       â”œâ”€â”€ index.tsx              # Public exports
â”‚       â”œâ”€â”€ TreeView.tsx           # Main container component
â”‚       â”œâ”€â”€ TreeItem.tsx           # Draggable tree item
â”‚       â”œâ”€â”€ TreeItemContent.tsx    # Item content renderer
â”‚       â”œâ”€â”€ DragOverlay.tsx        # Drag preview component
â”‚       â”œâ”€â”€ DropIndicator.tsx      # Drop target indicator
â”‚       â”œâ”€â”€ types.ts               # Component types
â”‚       â””â”€â”€ __tests__/
â”‚           â”œâ”€â”€ TreeView.test.tsx
â”‚           â”œâ”€â”€ TreeItem.test.tsx
â”‚           â””â”€â”€ reorder.test.ts
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ hooks/
â”‚       â”œâ”€â”€ useTreeDragDrop.ts     # Main DnD hook
â”‚       â”œâ”€â”€ useTreeReorder.ts      # Reorder mutation hook
â”‚       â””â”€â”€ __tests__/
â”‚           â”œâ”€â”€ useTreeDragDrop.test.ts
â”‚           â””â”€â”€ useTreeReorder.test.ts
â””â”€â”€ lib/
    â””â”€â”€ utils/
        â””â”€â”€ tree-utils.ts          # Tree manipulation utilities
```

---

## 4. Implementation Details

### 4.1 TreeView Component

```typescript
// Client/components/tree-view/TreeView.tsx
'use client';

import { useState, useMemo } from 'react';
import {
  DndContext,
  DragOverlay,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragStartEvent,
  DragEndEvent,
  DragOverEvent,
} from '@dnd-kit/core';
import {
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';
import { logger } from '@/lib/logger';
import { useTreeReorder } from '@/lib/hooks/useTreeReorder';
import { TreeItem } from './TreeItem';
import { DragOverlayContent } from './DragOverlay';
import type { WorkItem, TreeViewProps } from './types';

export function TreeView({ items, onReorder, className }: TreeViewProps) {
  const [activeId, setActiveId] = useState<string | null>(null);
  const [overId, setOverId] = useState<string | null>(null);

  const { reorder, isPending } = useTreeReorder();

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Prevent accidental drags
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const activeItem = useMemo(
    () => items.find((item) => item.id === activeId),
    [items, activeId]
  );

  const handleDragStart = (event: DragStartEvent) => {
    const { active } = event;
    setActiveId(active.id as string);
    logger.log('tree.drag', 'Drag started', { itemId: active.id });
  };

  const handleDragOver = (event: DragOverEvent) => {
    const { over } = event;
    setOverId(over?.id as string | null);
  };

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;

    setActiveId(null);
    setOverId(null);

    if (!over || active.id === over.id) {
      return;
    }

    logger.log('tree.reorder', 'Reorder requested', {
      itemId: active.id,
      targetId: over.id,
    });

    try {
      await reorder({
        itemId: active.id as string,
        targetId: over.id as string,
      });
      onReorder?.();
    } catch (error) {
      logger.error('tree.reorder', 'Reorder failed', { error });
      // TanStack Query will handle rollback via optimistic update
    }
  };

  const itemIds = useMemo(() => items.map((item) => item.id), [items]);

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragStart={handleDragStart}
      onDragOver={handleDragOver}
      onDragEnd={handleDragEnd}
    >
      <SortableContext items={itemIds} strategy={verticalListSortingStrategy}>
        <div className={className} role="tree" aria-label="Work items tree">
          {items.map((item) => (
            <TreeItem
              key={item.id}
              item={item}
              isActive={activeId === item.id}
              isOver={overId === item.id}
              depth={0}
            />
          ))}
        </div>
      </SortableContext>

      <DragOverlay>
        {activeItem ? <DragOverlayContent item={activeItem} /> : null}
      </DragOverlay>
    </DndContext>
  );
}
```

### 4.2 TreeItem Component

```typescript
// Client/components/tree-view/TreeItem.tsx
'use client';

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { GripVertical, ChevronRight, ChevronDown } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { WorkItem, TreeItemProps } from './types';

export function TreeItem({ item, isActive, isOver, depth }: TreeItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: item.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  const [isExpanded, setIsExpanded] = useState(true);
  const hasChildren = item.children && item.children.length > 0;

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        'tree-item',
        isDragging && 'tree-item--dragging',
        isOver && 'tree-item--over'
      )}
      role="treeitem"
      aria-expanded={hasChildren ? isExpanded : undefined}
      aria-selected={isActive}
    >
      <div
        className={cn(
          'tree-item__content',
          'flex items-center gap-2 p-2 rounded-md',
          'hover:bg-muted/50 transition-colors',
          isDragging && 'opacity-50',
          isOver && 'ring-2 ring-primary'
        )}
        style={{ paddingLeft: `${depth * 24 + 8}px` }}
      >
        {/* Drag Handle */}
        <button
          className="tree-item__handle cursor-grab active:cursor-grabbing"
          {...attributes}
          {...listeners}
          aria-label={`Drag to reorder ${item.title}`}
        >
          <GripVertical className="h-4 w-4 text-muted-foreground" />
        </button>

        {/* Expand/Collapse */}
        {hasChildren && (
          <button
            className="tree-item__toggle"
            onClick={() => setIsExpanded(!isExpanded)}
            aria-label={isExpanded ? 'Collapse' : 'Expand'}
          >
            {isExpanded ? (
              <ChevronDown className="h-4 w-4" />
            ) : (
              <ChevronRight className="h-4 w-4" />
            )}
          </button>
        )}

        {/* Item Content */}
        <TreeItemContent item={item} />
      </div>

      {/* Children */}
      {hasChildren && isExpanded && (
        <div role="group" className="tree-item__children">
          {item.children!.map((child) => (
            <TreeItem
              key={child.id}
              item={child}
              isActive={false}
              isOver={false}
              depth={depth + 1}
            />
          ))}
        </div>
      )}
    </div>
  );
}
```

### 4.3 Reorder Hook

```typescript
// Client/lib/hooks/useTreeReorder.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { logger } from '@/lib/logger';
import { useNotification } from '@/lib/hooks/useNotification';
import { workItemsApi } from '@/api/work-items';
import { queryKeys } from '@/lib/query-keys';
import type { WorkItem, ReorderPayload } from '@/types/work-item';

export function useTreeReorder() {
  const queryClient = useQueryClient();
  const notify = useNotification();

  return useMutation({
    mutationFn: async (payload: ReorderPayload) => {
      return workItemsApi.reorder(payload);
    },

    onMutate: async (payload) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: queryKeys.workItems.all });

      // Snapshot previous value
      const previousItems = queryClient.getQueryData<WorkItem[]>(
        queryKeys.workItems.all
      );

      // Optimistically update the cache
      if (previousItems) {
        const newItems = reorderItems(previousItems, payload);
        queryClient.setQueryData(queryKeys.workItems.all, newItems);
      }

      logger.log('tree.reorder', 'Optimistic update applied', { payload });

      return { previousItems };
    },

    onError: (error, payload, context) => {
      // Rollback on error
      if (context?.previousItems) {
        queryClient.setQueryData(
          queryKeys.workItems.all,
          context.previousItems
        );
      }
      logger.error('tree.reorder', 'Reorder failed, rolling back', { error });
      notify.error('Failed to reorder item');
    },

    onSuccess: () => {
      logger.log('tree.reorder', 'Reorder successful');
      notify.success('Item reordered');
    },

    onSettled: () => {
      // Refetch to ensure consistency
      queryClient.invalidateQueries({ queryKey: queryKeys.workItems.all });
    },
  });
}

// Helper function to reorder items in the tree
function reorderItems(
  items: WorkItem[],
  payload: ReorderPayload
): WorkItem[] {
  // Implementation of tree reordering logic
  // ... (see tree-utils.ts for full implementation)
}
```

### 4.4 API Service Update

```typescript
// Client/api/work-items.ts
import { BaseApiService } from './base';
import type { WorkItem, ReorderPayload } from '@/types/work-item';

class WorkItemsApiService extends BaseApiService {
  async reorder(payload: ReorderPayload): Promise<WorkItem> {
    return this.put<{ data: WorkItem }>(
      `/work-items/${payload.itemId}`,
      {
        position: payload.newPosition,
        parent: payload.newParentId,
      }
    ).then(res => res.data);
  }
}

export const workItemsApi = new WorkItemsApiService();
```

---

## 5. Testing Strategy

### 5.1 Unit Tests

```typescript
// Client/components/tree-view/__tests__/TreeView.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@/test/test-utils';
import { TreeView } from '../TreeView';
import { mockWorkItems } from '@/test/fixtures/work-items';

describe('TreeView', () => {
  it('renders all items', () => {
    render(<TreeView items={mockWorkItems} />);

    mockWorkItems.forEach((item) => {
      expect(screen.getByText(item.title)).toBeInTheDocument();
    });
  });

  it('shows drag handle on each item', () => {
    render(<TreeView items={mockWorkItems} />);

    const handles = screen.getAllByRole('button', { name: /drag to reorder/i });
    expect(handles).toHaveLength(mockWorkItems.length);
  });

  it('applies correct ARIA attributes', () => {
    render(<TreeView items={mockWorkItems} />);

    expect(screen.getByRole('tree')).toBeInTheDocument();
    expect(screen.getAllByRole('treeitem')).toHaveLength(mockWorkItems.length);
  });
});
```

### 5.2 Integration Tests

```typescript
// Client/components/tree-view/__tests__/reorder.test.ts
import { describe, it, expect, vi } from 'vitest';
import { renderHook, waitFor } from '@testing-library/react';
import { useTreeReorder } from '@/lib/hooks/useTreeReorder';
import { createWrapper } from '@/test/test-utils';
import { server } from '@/test/mocks/server';
import { http, HttpResponse } from 'msw';

describe('useTreeReorder', () => {
  it('optimistically updates the cache', async () => {
    const { result } = renderHook(() => useTreeReorder(), {
      wrapper: createWrapper(),
    });

    result.current.mutate({
      itemId: 'item-1',
      newPosition: 2,
    });

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true);
    });
  });

  it('rolls back on error', async () => {
    server.use(
      http.put('/api/work-items/:id', () => {
        return HttpResponse.json({ error: 'Server error' }, { status: 500 });
      })
    );

    const { result } = renderHook(() => useTreeReorder(), {
      wrapper: createWrapper(),
    });

    result.current.mutate({
      itemId: 'item-1',
      newPosition: 2,
    });

    await waitFor(() => {
      expect(result.current.isError).toBe(true);
    });
  });
});
```

### 5.3 E2E Tests

```typescript
// tests/e2e/drag-drop.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Drag and Drop Reordering', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/dashboard/projects/test-project');
  });

  test('can drag an item to reorder', async ({ page }) => {
    const item1 = page.getByRole('treeitem', { name: /Feature 1/ });
    const item2 = page.getByRole('treeitem', { name: /Feature 2/ });

    const item1Box = await item1.boundingBox();
    const item2Box = await item2.boundingBox();

    if (!item1Box || !item2Box) throw new Error('Items not found');

    // Drag item 1 to item 2's position
    await page.mouse.move(item1Box.x + 20, item1Box.y + 10);
    await page.mouse.down();
    await page.mouse.move(item2Box.x + 20, item2Box.y + 10, { steps: 10 });
    await page.mouse.up();

    // Verify order changed
    const items = await page.getByRole('treeitem').allTextContents();
    expect(items[0]).toContain('Feature 2');
    expect(items[1]).toContain('Feature 1');
  });

  test('can use keyboard to reorder', async ({ page }) => {
    const item1 = page.getByRole('treeitem', { name: /Feature 1/ });

    await item1.focus();
    await page.keyboard.press('Alt+ArrowDown');

    // Verify order changed
    const items = await page.getByRole('treeitem').allTextContents();
    expect(items[1]).toContain('Feature 1');
  });
});
```

---

## 6. Acceptance Criteria

| # | Criteria | Test Method |
|---|----------|-------------|
| AC-1 | Users can drag work items to reorder within same level | E2E test |
| AC-2 | Users can drag items to different parent (re-parenting) | E2E test |
| AC-3 | Visual drag indicator shows during drag | Manual + Screenshot |
| AC-4 | Drop indicator shows valid drop locations | Manual + Screenshot |
| AC-5 | Position changes persist after page refresh | E2E test |
| AC-6 | Optimistic update shows immediately | Integration test |
| AC-7 | Rollback occurs on API error | Integration test |
| AC-8 | Keyboard reordering works (Alt+Up/Down) | E2E test |
| AC-9 | Screen reader announces reorder actions | Manual a11y audit |
| AC-10 | Works on touch devices | Manual test on tablet |

---

## 7. Dependencies

### 7.1 New Dependencies

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

### 7.2 Remove (Optional)

Consider removing deprecated libraries after migration:
- `react-beautiful-dnd` (deprecated)
- `react-dnd` and `react-dnd-html5-backend` (if not used elsewhere)

### 7.3 Blocking Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| Strapi work-item schema | Needs update | Add `position` field |
| TanStack Query setup | Exists | Already configured |
| Zustand store | Exists | Already configured |

---

## 8. Rollout Plan

### 8.1 Implementation Order

1. **Day 1:** Install @dnd-kit, update Strapi schema
2. **Day 2:** Implement TreeView and TreeItem components
3. **Day 3:** Implement useTreeReorder hook and API
4. **Day 4:** Write unit and integration tests
5. **Day 5:** E2E tests, accessibility audit, final polish

### 8.2 Feature Flags

No feature flag needed - this is a new component replacing static lists.

### 8.3 Migration Strategy

1. Create new TreeView component (doesn't affect existing code)
2. Update existing list components to use TreeView
3. Remove old list rendering code

---

## 9. AI Agent Export Formats

### 9.1 Cursor Rules

```markdown
---
title: F1.1.1 Drag-Drop Reordering
description: Implementation rules for drag-drop tree reordering
globs: ["Client/components/tree-view/**/*", "Client/lib/hooks/useTree*.ts"]
---

# Feature: Drag-Drop Reordering

## Tech Stack
- @dnd-kit/core, @dnd-kit/sortable for DnD
- TanStack Query for server state
- Zustand for UI state

## Key Patterns
- Optimistic updates with rollback
- ARIA tree/treeitem roles for accessibility
- CSS transforms for smooth animation

## Files to Create
1. Client/components/tree-view/TreeView.tsx
2. Client/components/tree-view/TreeItem.tsx
3. Client/lib/hooks/useTreeReorder.ts

## Acceptance Criteria
- Drag items to reorder
- Visual feedback during drag
- Persist to Strapi CMS
- Keyboard accessible
```

---

## 10. References

### 10.1 Related Documents

- [CODING_STANDARDS.md](../../CODING_STANDARDS.md) - Coding patterns
- [ARCHITECTURE_PATTERNS.md](../../ARCHITECTURE_PATTERNS.md) - Architecture
- [PHASE_1_OVERVIEW.md](./PHASE_1_OVERVIEW.md) - Phase context

### 10.2 External Resources

- [@dnd-kit Documentation](https://docs.dndkit.com/)
- [ARIA Tree Pattern](https://www.w3.org/WAI/ARIA/apg/patterns/treeview/)
- [TanStack Query Optimistic Updates](https://tanstack.com/query/latest/docs/framework/react/guides/optimistic-updates)

---

**Document Version:** 1.0.0
**Status:** ðŸ“‹ Ready for Implementation
