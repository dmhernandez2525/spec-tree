# Spec Tree - Render Infrastructure Configuration (FREE TIER)
# ===========================================================
# This configuration deploys all services using FREE tiers for development/demo.
#
# IMPORTANT LIMITATIONS (as of January 2026):
# - All web services spin down after 15 minutes of inactivity (~30s cold start)
# - Free PostgreSQL database EXPIRES AFTER 30 DAYS (must upgrade or recreate)
# - No persistent disks on free tier (uploads are lost on redeploy)
# - 750 free instance hours/month per workspace
#
# Cost: $0/month (with above limitations)
#
# For production, change plans to 'starter' and add disk to Strapi.
# See: https://render.com/docs/free
#
# NOTE: Values marked "UPDATE_ME" must be configured manually after deployment

services:
  # =============================================
  # Client - Next.js Frontend
  # =============================================
  - type: web
    name: spec-tree-client
    runtime: node
    plan: free
    buildCommand: cd Client && rm -rf node_modules && npm install && npm run build
    startCommand: cd Client && npm run start
    envVars:
      - key: NODE_VERSION
        value: "20"
      - key: NODE_ENV
        value: production
      # Strapi CMS connection
      - key: NEXT_PUBLIC_STRAPI_API_URL
        fromService:
          name: spec-tree-strapi
          type: web
          property: hostport
      - key: NEXT_PUBLIC_STRAPI_TOKEN
        value: UPDATE_ME
      # Microservice connection
      - key: NEXT_PUBLIC_MICROSERVICE_URL
        fromService:
          name: spec-tree-microservice
          type: web
          property: hostport
      - key: NEXT_PUBLIC_MICROSERVICE_API_KEY
        value: UPDATE_ME
      # Stripe configuration (optional for dev)
      - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        value: UPDATE_ME
      - key: NEXT_PUBLIC_STRIPE_STARTER_PRICE_ID
        value: UPDATE_ME
      - key: NEXT_PUBLIC_STRIPE_PRO_PRICE_ID
        value: UPDATE_ME
      - key: NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID
        value: UPDATE_ME
      # Optional: Analytics & Error Tracking
      - key: NEXT_PUBLIC_GA_ID
        value: ""
      - key: NEXT_PUBLIC_SENTRY_DSN
        value: ""

  # =============================================
  # Server - Strapi CMS Backend
  # =============================================
  # NOTE: Free tier has no persistent disk. Uploads will be lost on redeploy.
  # For persistent uploads, either:
  # 1. Upgrade to 'starter' plan and add disk
  # 2. Configure AWS S3 for uploads (set AWS_* env vars below)
  - type: web
    name: spec-tree-strapi
    runtime: node
    plan: free
    buildCommand: cd Server && npm install --force && npm run build
    startCommand: cd Server && npm run start
    healthCheckPath: /_health
    envVars:
      - key: NODE_VERSION
        value: "18"
      - key: NODE_ENV
        value: production
      - key: HOST
        value: "0.0.0.0"
      - key: PORT
        value: "1337"
      # Database connection (auto-populated from Render PostgreSQL)
      - key: DATABASE_URL
        fromDatabase:
          name: spec-tree-db
          property: connectionString
      - key: DATABASE_CLIENT
        value: postgres
      - key: DATABASE_SSL
        value: "true"
      # Security keys (auto-generated)
      - key: APP_KEYS
        generateValue: true
      - key: API_TOKEN_SALT
        generateValue: true
      - key: ADMIN_JWT_SECRET
        generateValue: true
      - key: TRANSFER_TOKEN_SALT
        generateValue: true
      - key: JWT_SECRET
        generateValue: true
      # Email (SendGrid) - optional
      - key: SENDGRID_API_KEY
        value: UPDATE_ME
      # AWS S3 for uploads - recommended for free tier (no local disk)
      - key: AWS_ACCESS_KEY_ID
        value: UPDATE_ME
      - key: AWS_SECRET_ACCESS_KEY
        value: UPDATE_ME
      - key: AWS_REGION
        value: UPDATE_ME
      - key: AWS_BUCKET_NAME
        value: UPDATE_ME

  # =============================================
  # Microservice - OpenAI API Proxy
  # =============================================
  - type: web
    name: spec-tree-microservice
    runtime: node
    plan: free
    buildCommand: cd Microservice && npm install && npm run build
    startCommand: cd Microservice && npm run start
    envVars:
      - key: NODE_VERSION
        value: "20"
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3001"
      # OpenAI API key (REQUIRED - set manually)
      - key: OPENAI_API_KEY
        value: UPDATE_ME
      # CORS - allow requests from client
      - key: CORS_ORIGIN
        fromService:
          name: spec-tree-client
          type: web
          property: hostport
      # API key for client authentication
      - key: API_KEY
        generateValue: true

# =============================================
# Database - PostgreSQL for Strapi
# =============================================
# WARNING: Free tier database EXPIRES after 30 days!
# You will need to upgrade to 'basic-256mb' ($7/month) or recreate.
# Data will be lost if the database expires.
databases:
  - name: spec-tree-db
    plan: free
    databaseName: spec_tree
    user: spec_tree_user
